# -----------------------------------------------------------------------------
# üê≥ Docker Compose file for OPC UA Connector (OpenFactory)
#
# This file defines the services required to run the OPC UA Connector stack:
# 1. opcua-coordinator   - Orchestrates device assignments across gateways
# 2. opcua-gateway       - Connects to OPC UA servers, monitors devices, and
#                          streams data to OpenFactory via Kafka
#
# Both services are connected through the 'factory-net' Docker network.
#
# Usage (local):
#   # Start services
#   docker compose up -d
#
#   # Stop services
#   docker compose down
#
# Usage (docker swarm):
#   # Source environment variables for an .env file
#   set -a && source .env && set +a
#   # Deploy the stack
#   docker stack deploy -c docker-compose.yml opcua-connector
#
#   # Remove stack
#   docker stack rm opcua-connector
#
# Environment variables:
#   NODE_HOSTNAME            Hostname of the Docker swarm host (default {{.Node.Hostname}})
#   COORDINATOR_URL          URL of the coordinator (default: http://opcua-coordinator:8000)
#   KAFKA_BROKER             Kafka bootstrap server (required)
#   KSQLDB_URL               ksqlDB URL (required)
#   OPCUA_GATEWAY_LOG_LEVEL  Log level (optional, default: INFO)
#
# Ports:
#   Coordinator API: 8000
#
# External network required:
#   factory-net
# -----------------------------------------------------------------------------

services:
  opcua-gateway:
    image: ghcr.io/openfactoryio/opcua-gateway
    environment:
      - NODE_HOSTNAME={{.Node.Hostname}}
      - COORDINATOR_URL=http://opcua-coordinator:8000
      - KAFKA_BROKER=${KAFKA_BROKER}
      - KSQLDB_URL=${KSQLDB_URL}
      - OPCUA_GATEWAY_LOG_LEVEL=${OPCUA_GATEWAY_LOG_LEVEL:-INFO}
    networks:
      - factory-net
    deploy:
      replicas: 3

  opcua-coordinator:
    image: ghcr.io/openfactoryio/opcua-coordinator
    environment:
      - KAFKA_BROKER=${KAFKA_BROKER}
      - KSQLDB_URL=${KSQLDB_URL}
    ports:
      - "8000:8000"
    networks:
      - factory-net

networks:

    factory-net:
      external: true
