# ----------------------------------------------------------------------------------
# Prometheus rules for the OpenFactory OPCUA Connector
#
# Purpose:
#   This file contains recording rules for metrics generated by OPCUA Coordinator
#   and Gateway components. Users can drop this file into their Prometheus setup
#   and reference it under the rule_files section.
#
# How to use:
#   In prometheus.yml, include it with rule_files:
#
#   rule_files:
#     - "opcua_connector_rules.yml"
#
# Notes:
#   - Each group defines a set of related rules with a common evaluation interval.
#   - Labels defined in each rule (component, role) will be attached to the
#     resulting metrics and can be used for filtering or aggregating.
# ----------------------------------------------------------------------------------

groups:
  - name: opcua_connector_gateway_metrics
    interval: 15s
    rules:
      # Build info per gateway
      - record: gateway:opcua_build_info
        expr: opcua_gateway_build_info
        labels:
          component: "opcua_connector"
          role: "gateway"

      # Message throughput per gateway (messages/sec)
      - record: gateway:messages_sent_rate
        expr: sum(rate(opcua_messages_sent_total[1m])) by (gateway)
        labels:
          component: "opcua_connector"
          role: "gateway"

      # Total message throughput (messages/sec)
      - record: gateway:opcua_messages_rate_total
        expr: sum(rate(opcua_messages_sent_total[1m]))
        labels:
          component: "opcua_connector"
          role: "gateway"

      # Average internal queue size per gateway
      - record: gateway:opcua_queue_size_avg
        expr: avg(opcua_queue_size) by (gateway)
        labels:
          component: "opcua_connector"
          role: "gateway"

      # Event loop lag per gateway
      - record: gateway:event_loop_lag_avg
        expr: rate(opcua_event_loop_lag_seconds_sum[1m])
              /
              rate(opcua_event_loop_lag_seconds_count[1m])
        labels:
          component: "opcua_connector"
          role: "gateway"

      # 95th percentile event loop lag per gateway
      - record: gateway:event_loop_lag_p95
        expr: histogram_quantile(
                0.95,
                sum(rate(opcua_event_loop_lag_seconds_bucket[1m])) by (le)
              )
        labels:
          component: "opcua_connector"
          role: "gateway"

      # 99th percentile event loop lag per gateway
      - record: gateway:event_loop_lag_p99
        expr: histogram_quantile(
                0.99,
                sum(rate(opcua_event_loop_lag_seconds_bucket[1m])) by (le)
              )
        labels:
          component: "opcua_connector"
          role: "gateway"

  - name: opcua_connector_coordinator_metrics
    interval: 15s
    rules:
      # Build info per coordinator
      - record: coordinator:opcua_build_info
        expr: opcua_coordinator_build_info
        labels:
          component: "opcua_connector"
          role: "coordinator"

      # Total devices across all gateways
      - record: coordinator:total_devices
        expr: sum(opcua_gateway_devices_count)
        labels:
          component: "opcua_connector"
          role: "coordinator"

      # Max devices on a single gateway
      - record: coordinator:max_devices_per_gateway
        expr: max(opcua_gateway_devices_count) by (gateway_id)
        labels:
          component: "opcua_connector"
          role: "coordinator"

      # Min devices on a single gateway
      - record: coordinator:min_devices_per_gateway
        expr: min(opcua_gateway_devices_count) by (gateway_id)
        labels:
          component: "opcua_connector"
          role: "coordinator"


  - name: opcua_connector_coordinator_device_assignment
    interval: 15s
    rules:
      # Rate of device assignments per second
      - record: coordinator:device_assignments_rate
        expr: rate(opcua_device_assignments_total[1m])
        labels:
          component: "opcua_connector"
          role: "coordinator"

      # Average latency for assigning a device
      - record: coordinator:device_assignment_latency_avg
        expr: sum(rate(opcua_device_assignment_latency_seconds_sum[1m]))
              /
              sum(rate(opcua_device_assignment_latency_seconds_count[1m]))
        labels:
          component: "opcua_connector"
          role: "coordinator"

      # 95th percentile latency for device assignments
      - record: coordinator:device_assignment_latency_p95
        expr: histogram_quantile(
                0.95,
                sum(rate(opcua_device_assignment_latency_seconds_bucket[1m])) by (le)
              )
        labels:
          component: "opcua_connector"
          role: "coordinator"
